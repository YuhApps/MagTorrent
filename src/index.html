<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagTorrent</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="card">
        <span style="width: 80px;"></span>
        <input type="text" placeholder="Search or Magnet URL (magnet:?xt=urn:btih:). ">
        <span style="width: 80px;"></span>
        <!-- <span style="width: 12px;"></span>
        <button class="option-button" title="Add Torrent" onclick="addTorrent()">
            <svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.002 2c5.518 0 9.998 4.48 9.998 9.998 0 5.517-4.48 9.997-9.998 9.997-5.517 0-9.997-4.48-9.997-9.997 0-5.518 4.48-9.998 9.997-9.998zm0 1.5c-4.69 0-8.497 3.808-8.497 8.498s3.807 8.497 8.497 8.497 8.498-3.807 8.498-8.497-3.808-8.498-8.498-8.498zm-.747 7.75h-3.5c-.414 0-.75.336-.75.75s.336.75.75.75h3.5v3.5c0 .414.336.75.75.75s.75-.336.75-.75v-3.5h3.5c.414 0 .75-.336.75-.75s-.336-.75-.75-.75h-3.5v-3.5c0-.414-.336-.75-.75-.75s-.75.336-.75.75z"/></svg>
        </button>
        <span style="width: 8px;"></span>
        <button class="option-button" title="Options">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m11.998 2c5.517 0 9.997 4.48 9.997 9.998 0 5.517-4.48 9.997-9.997 9.997-5.518 0-9.998-4.48-9.998-9.997 0-5.518 4.48-9.998 9.998-9.998zm0 1.5c-4.69 0-8.498 3.808-8.498 8.498s3.808 8.497 8.498 8.497 8.497-3.807 8.497-8.497-3.807-8.498-8.497-8.498zm2.502 8.495c0-.69.56-1.25 1.25-1.25s1.25.56 1.25 1.25-.56 1.25-1.25 1.25-1.25-.56-1.25-1.25zm-3.75 0c0-.69.56-1.25 1.25-1.25s1.25.56 1.25 1.25-.56 1.25-1.25 1.25-1.25-.56-1.25-1.25zm-3.75 0c0-.69.56-1.25 1.25-1.25s1.25.56 1.25 1.25-.56 1.25-1.25 1.25-1.25-.56-1.25-1.25z"/></svg>    
        </button> -->
        <button id="minimize" onclick="minimize()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m21 11.75c0-.414-.336-.75-.75-.75h-16.5c-.414 0-.75.336-.75.75s.336.75.75.75h16.5c.414 0 .75-.336.75-.75z"/></svg>
        </button>
        <button id="maximize" onclick="maximize()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.25,5.5c0,-0.414 -0.336,-0.75 -0.75,-0.75l-13,0c-0.414,0 -0.75,0.336 -0.75,0.75l0,13c0,0.414 0.336,0.75 0.75,0.75l13,0c0.414,0 0.75,-0.336 0.75,-0.75l0,-13Zm-1.5,0.75l0,11.5c-0,0 -11.5,0 -11.5,0c-0,-0 -0,-11.5 -0,-11.5l11.5,0Z"/></svg>
        </button>
        <button id="unmaximize" class="hidden" onclick="unmaximize()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M16.25,8.5c0,-0.414 -0.336,-0.75 -0.75,-0.75l-10,0c-0.414,0 -0.75,0.336 -0.75,0.75l0,10c0,0.414 0.336,0.75 0.75,0.75l10,0c0.414,0 0.75,-0.336 0.75,-0.75l0,-10Zm-1.5,0.75l-0,8.5c0,0 -8.5,0 -8.5,0c0,0 -0,-8.5 -0,-8.5l8.5,-0Z"/><path d="M8.5,6.25l9.25,-0c0,-0 0,6.701 0,8.407c-0,0.511 -0,0.843 -0,0.843c0,0.414 0.336,0.75 0.75,0.75c0.414,-0 0.75,-0.336 0.75,-0.75l-0,-10c0,-0.414 -0.336,-0.75 -0.75,-0.75l-10,-0c-0.414,0 -0.75,0.336 -0.75,0.75c0,0.414 0.336,0.75 0.75,0.75Z"/></svg>
        </button>
        <button id="close" onclick="closeWindow()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12 10.93 5.719-5.72c.146-.146.339-.219.531-.219.404 0 .75.324.75.749 0 .193-.073.385-.219.532l-5.72 5.719 5.719 5.719c.147.147.22.339.22.531 0 .427-.349.75-.75.75-.192 0-.385-.073-.531-.219l-5.719-5.719-5.719 5.719c-.146.146-.339.219-.531.219-.401 0-.75-.323-.75-.75 0-.192.073-.384.22-.531l5.719-5.719-5.72-5.719c-.146-.147-.219-.339-.219-.532 0-.425.346-.749.75-.749.192 0 .385.073.531.219z"/></svg>
        </button>
    </header>
    <main>
        <div id="message">Loading data from previous session...</div>
        <ul></ul>
    </main>
    <script>
        const oneGB = 1024*1024*1024
        const oneMB = 1024*1024
        const oneKB = 1024
        const oneHour = 3600
        const oneMinute = 60
        const { ipcRenderer } = require('electron')
        const searchBox = document.querySelector('input')
        const message = document.querySelector('#message')
        const ul = document.querySelector('ul')

        function getSize(size) {
            if (size === undefined) {
                return '∞B'
            } else if (size > oneGB) {
                let gb = String(size / oneGB)
                let dotIndex = gb.indexOf('.')
                return gb.substring(0, dotIndex + 3) + 'GB'
            } else if (size > oneMB) {
                let mb = String(size / oneMB)
                let dotIndex = mb.indexOf('.')
                return mb.substring(0, dotIndex + 3) + 'MB'
            } else if (size > oneKB) {
                let kb = String(size / oneKB)
                let dotIndex = kb.indexOf('.')
                return kb.substring(0, dotIndex + 3) + 'KB'
            } else if (String(size).length > 3){
                return String(size).substring(0, 3) + 'B'
            } else {
                return size + 'B'
            }
        }

        function getTime(seconds) {
            try {
                return new Date(seconds).toISOString().slice(11, 19)
            } catch (error) {
                return '∞'
            }
        }

        function addTorrent() {
            ipcRenderer.send('show-add-torrent-box')
        }

        function search(text) {
            document.querySelectorAll('li').forEach((li) => {
                if (li.querySelector('.torrent-name').textContent.toLowerCase().indexOf(text.toLowerCase()) > -1) {
                    li.classList.remove('hidden')
                } else {
                    li.classList.add('hidden')
                }
            })
        }

        /*
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark')
            } else {
                document.body.classList.remove('dark')
            }
        })
        */

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
            if (event.matches) {
                document.body.classList.add('dark')
            } else {
                document.body.classList.remove('dark')
            }
        })

        searchBox.onkeyup = (e) => {
            let text = e.target.value
            if (text.startsWith('magnet:?xt=urn:btih:')) {
                ipcRenderer.send('add-torrent', text)
                e.target.value = ''
            } else {
                search(text)
            }
        }

        function minimize() {
            ipcRenderer.send('minimize-mw')
        }

        function maximize() {
            ipcRenderer.send('maximize-mw')
            document.querySelector('#maximize').classList.add('hidden')
            document.querySelector('#unmaximize').classList.remove('hidden')
        }

        function unmaximize() {
            ipcRenderer.send('unmaximize-mw')
            document.querySelector('#maximize').classList.remove('hidden')
            document.querySelector('#unmaximize').classList.add('hidden')
        }

        function closeWindow() {
            ipcRenderer.send('close-mw')
        }

        ipcRenderer.on('platform', (e, platform, dark) => {
            searchBox.placeholder += `Use ${platform === 'darwin' ? 'Cmd' : 'Ctrl'}+V to paste.`
            if (dark) {
                document.body.classList.add('dark')
            } else {
                document.body.classList.remove('dark')
            }
        })

        ipcRenderer.on('options-menu-closed', (e) => {
            document.querySelectorAll('li.selected').forEach((li) => li.classList.remove('selected'))
        })

        ipcRenderer.on('delete-all-torrents', (e) => {
            ul.innerHTML = ''
        })

        ipcRenderer.on('remove-torrent', (e, infoHash) => {
            let li = document.querySelector('#info-hash-' + infoHash)
            if (li) ul.removeChild(li)
        })

        ipcRenderer.on('torrent-done', (e, infoHash, length) => {
            let li = document.querySelector('#info-hash-' + infoHash)
            let meta = li.querySelector('span.torrent-meta')
            li.classList.add('downloaded')
            li.classList.remove('downloading')
            li.classList.remove('error')
            li.classList.remove('stopped')
            meta.innerHTML = `✓ Download complete (${getSize(length)}).`
        })

        ipcRenderer.on('torrent-error', (e, infoHash, error) => {
            let li = document.querySelector('#info-hash-' + infoHash)
            let meta = li.querySelector('span.torrent-meta')
            li.classList.remove('downloaded')
            li.classList.remove('downloading')
            li.classList.add('error')
            li.classList.remove('stopped')
            meta.innerHTML = `‼ Error: ${error}.`
        })

        ipcRenderer.on('adding-torrent', (e) => {
            message.classList.remove('hidden')
            message.innerHTML = 'Adding torrent...'
        })

        ipcRenderer.on('update-torrents', (e, torrents) => {
            if (torrents.length === 0) {
                message.classList.remove('hidden')
                message.innerHTML = `There are no active transfers.<br>
                                    To add a torrent, paste a magnet link to the<br>
                                    search box above, or add a .torrent file.`
            } else {
                message.classList.add('hidden')
            }
            torrents.forEach((torrent) => {
                let li = document.querySelector('#info-hash-' + torrent.infoHash)
                if (li === undefined || li === null) {
                    li = document.createElement('li')
                    li.className = 'card torrent downloading'
                    li.id = 'info-hash-' + torrent.infoHash
                    li.setAttribute('done', torrent.done)
                    li.innerHTML =
                        `
                        <div class="torrent-info">
                            <span class="torrent-name">${torrent.name}</span>
                            <br>
                            <span class="torrent-meta">Getting info...</span>
                        </div>
                        `
                    li.oncontextmenu = (e) => {
                        li.classList.add('selected')
                        ipcRenderer.send('show-torrent-options', torrent, { x: e.clientX, y: e.clientY })
                    }
                    li.ondblclick = (e) => {
                        ipcRenderer.send('open-torrent', torrent)
                    }
                    ul.prepend(li)
                }
                let meta = li.querySelector('span.torrent-meta')
                if (torrent.error !== undefined && torrent.paused) {
                    console.log('abc')
                    li.classList.remove('downloaded')
                    li.classList.remove('downloading')
                    li.classList.add('error')
                    li.classList.remove('stopped')
                    meta.innerHTML = `‼ Error: ${torrent.error}.`
                } else if (torrent.done) {
                    li.classList.add('downloaded')
                    li.classList.remove('downloading')
                    li.classList.remove('error')
                    li.classList.remove('stopped')
                    meta.innerHTML = `✓ Download complete (${getSize(torrent.length)})` + ` ↑${getSize(torrent.uploadSpeed)}/s.`
                } else if (torrent.paused) {
                    li.classList.remove('downloaded')
                    li.classList.remove('downloading')
                    li.classList.remove('error')
                    li.classList.add('stopped')
                    meta.innerHTML = `|| ${Math.round(torrent.progress * 100)}% of ${getSize(torrent.length)}, ${getTime(torrent.timeRemaining)} second${Math.round(torrent.timeRemaining/1000) < 2 ? '' : 's'} left. ↓ ${getSize(torrent.downloadSpeed)}/s ↑${getSize(torrent.uploadSpeed)}/s.`
                } else if (torrent.ready) {
                    li.classList.remove('downloaded')
                    li.classList.add('downloading')
                    li.classList.remove('error')
                    li.classList.remove('stopped')
                    meta.innerHTML = `↕ ${Math.round(torrent.progress * 100)}% of ${getSize(torrent.length)}, ${getTime(torrent.timeRemaining)} second${Math.round(torrent.timeRemaining/1000) < 2 ? '' : 's'} left. ↓ ${getSize(torrent.downloadSpeed)}/s ↑${getSize(torrent.uploadSpeed)}/s.`
                } else {
                    li.classList.remove('downloaded')
                    li.classList.add('downloading')
                    li.classList.remove('error')
                    li.classList.remove('stopped')
                    meta.innerHTML = `∞ Getting info...`
                }
            })
        })
    </script>
</body>
</html>